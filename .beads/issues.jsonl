{"id":"zebra-h2b-audit-v2-5pd","title":"Integrate SimilarValuePopover into columns.tsx","description":"Update columns.tsx to wrap Similar Value badges with the new popover component.\n\n## Requirements  \n- Pass allRows to the column definition\n- Wrap each Similar Value badge in SimilarValuePopover\n- Maintain existing badge styling and layout\n\n## CRITICAL - Check Context7 MCP FIRST for:\n- TanStack Table cell meta/context patterns\n- How to pass additional data to cell renderers\n- TanStack Table recommended approach (NOT custom hacks)\n\n## Files\n- Modify: apps/web/src/components/component-type-table/columns.tsx\n- Import: similar-value-popover.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-09T14:01:59.595113-06:00","updated_at":"2025-12-09T14:06:07.50825-06:00","closed_at":"2025-12-09T14:06:07.50825-06:00","dependencies":[{"issue_id":"zebra-h2b-audit-v2-5pd","depends_on_id":"zebra-h2b-audit-v2-9kl","type":"blocks","created_at":"2025-12-09T14:02:04.746557-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-7gy","title":"Similar Value Popover - HTB Distance Lookup","description":"When clicking a Similar Value pill in the component type table, show a popover with that term's HTB Distance matches.\n\n## Requirements\n- Click-based Popover (matches ProductCountPopover pattern)\n- Client-side lookup from already-loaded data\n- Memoized Map for O(1) performance\n\n## Implementation Notes\n**CRITICAL**: Check Context7 MCP for:\n- TanStack Table cell rendering patterns\n- React 19 memoization best practices\n- Radix Popover usage\n\nAvoid custom solutions - use TanStack Table's built-in patterns.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-09T14:01:46.853138-06:00","updated_at":"2025-12-09T14:06:07.508635-06:00","closed_at":"2025-12-09T14:06:07.508635-06:00"}
{"id":"zebra-h2b-audit-v2-9kl","title":"Create SimilarValuePopover component","description":"Create similar-value-popover.tsx component following ProductCountPopover pattern.\n\n## Requirements\n- Use Radix Popover (already in project)\n- Accept: pillValue (string), allRows (ComponentTypeRow[])\n- Show HTB Distance matches for the clicked term\n- Handle edge cases: not found, no matches\n\n## CRITICAL - Check Context7 MCP FIRST for:\n- React 19 patterns (useMemo, useCallback)\n- Radix Popover API\n- TanStack Table row data access patterns\n\n## Files\n- Create: apps/web/src/components/component-type-table/similar-value-popover.tsx\n- Reference: apps/web/src/components/component-type-table/product-count-popover.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-09T14:01:53.896622-06:00","updated_at":"2025-12-09T14:06:07.507655-06:00","closed_at":"2025-12-09T14:06:07.507655-06:00","dependencies":[{"issue_id":"zebra-h2b-audit-v2-9kl","depends_on_id":"zebra-h2b-audit-v2-7gy","type":"blocks","created_at":"2025-12-09T14:02:04.723528-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr","title":"Enhanced Similarity Reports and XLSX Import","description":"## Overview\nEnhance component type similarity analysis with detailed match information. Add HTB attribute mapping import from Zebra-provided Excel file with embeddings generation for semantic search.\n\n## Goals\n1. Enhanced Similarity Reports: TWO export buttons (CSV Report + JSON Report) with match % and positions\n2. HTB XLSX Import: Parse and store HTB-attribute-mapping-zebra-provided.xlsx\n3. Dual Embedding Generation: Both embedding_large (3072d) AND embedding_small (1536d)\n4. Config-Driven Embedding Sync: JSON config file defining table/column sources\n5. Incremental Sync: Only embed NEW values, remove STALE, skip unchanged\n6. UMAP Coordinates: Generate 2D/3D coordinates + TSV export for TensorFlow Projector\n\n## Files Affected\n- packages/api/src/routers/components.ts (SQL query)\n- apps/web/src/components/component-type-table/* (exports, UI)\n- packages/db/src/schema/zebra.ts (HTB table)\n- scripts/embeddings/* (sync infrastructure)\n- scripts/htb-import/* (XLSX parser)\n\n## Risks\n- SQL performance with JSONB agg → Test with EXPLAIN ANALYZE\n- OpenAI rate limits → Batching, exponential backoff\n- UMAP requires Python → Use uv for isolation","design":"## Technical Approach\n\n### Phase 1: Enhanced Export (Task 001)\n- Modify getComponentTypesWithSimilarity SQL to capture individual match scores\n- Add TWO export buttons: \"Export CSV Report\" and \"Export JSON Report\"\n- Backward-compatible: existing table UI unchanged\n\n### Phase 2: HTB Data Import (Tasks 002-004)\n- Create Drizzle schema for new table\n- Write parser script using existing SheetJS pattern\n- Import all columns from XLSX, focus on Column A for embeddings\n\n### Phase 3: Embedding Infrastructure (Tasks 005-007)\n- Config file: scripts/embeddings/embedding-sources.json\n- Sync script: Incremental with new/stale/unchanged detection\n- Dual embeddings: Both embedding_large AND embedding_small\n- UMAP script: Python/uv for 2D + 3D reduction\n- TSV export: Files for TensorFlow Projector","acceptance_criteria":"## Success Criteria\n- [ ] CSV Report has match % - Download shows per-match percentages\n- [ ] CSV Report has positions - Download shows positions per match\n- [ ] JSON Report full structure - Contains nested similarMatches array\n- [ ] HTB data imported - All ~100 rows in new table\n- [ ] Dual embeddings generated - Both embedding_large AND embedding_small populated\n- [ ] Incremental sync works - Re-run only processes changes\n- [ ] UMAP coordinates generated - umap_x_2d, umap_y_2d, etc. populated\n- [ ] TSV files exported - Files ready for TensorFlow Projector","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-09T10:34:34.711233-06:00","updated_at":"2025-12-09T10:34:34.711233-06:00","labels":["embeddings","epic","similarity","xlsx-import"]}
{"id":"zebra-h2b-audit-v2-wxr.1","title":"Enhanced CSV/JSON Reports with Match Scores","description":"## What\nAdd TWO new export buttons to /components page:\n1. Export CSV Report - Enhanced CSV with match % and positions per similar value\n2. Export JSON Report - Full structured JSON for advanced data analysis\n\nKeep existing Export CSV unchanged for backward compatibility.\n\n## Why\nCurrent export only shows similar value names without context. Users need:\n- Match percentage to understand similarity strength (85% vs 99%)\n- Position data to see where in SKU structure each match appears\n- JSON format for programmatic analysis\n\n## Scope\n- /packages/api/src/routers/components.ts - MODIFY SQL query\n- /apps/web/src/components/component-type-table/columns.tsx - MODIFY interface\n- /apps/web/src/components/component-type-table/csv-export.ts - MODIFY add report exports\n- /apps/web/src/components/component-type-table/index.tsx - MODIFY add two buttons","design":"## Interface\ninterface SimilarMatch { value: string; matchPercentage: number; positions: string[]; }\n\n## SQL Changes\nAdd jsonb_agg with matchPercentage and positions per similar value\n\n## CSV Format\nComponent Type,Source Positions,# Similar,Similar 1,Match 1 %,Match 1 Positions,...\n\n## JSON Format\n{ exportMetadata: {...}, data: [{ componentType, similarMatches: [...] }] }","acceptance_criteria":"| Criterion | Proof | Expected |\n|-----------|-------|----------|\n| Two new buttons visible | Navigate to /components | Export CSV Report + Export JSON Report buttons |\n| CSV Report downloads | Click button | File downloads with metadata header |\n| CSV has match % | Open CSV | Per-match percentage columns |\n| CSV has positions | Open CSV | Per-match position columns |\n| JSON Report downloads | Click button | .json file downloads |\n| JSON has metadata | Open JSON | exportMetadata object present |\n| Original export unchanged | Click Export CSV | Same format as before |","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-09T10:36:20.192401-06:00","updated_at":"2025-12-09T10:58:26.039741-06:00","closed_at":"2025-12-09T10:58:26.039741-06:00","labels":["export","phase-1","similarity"],"dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.1","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T10:36:20.192791-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr.2","title":"Parse HTB XLSX File","description":"## What\nCreate parser script to extract data from HTB-attribute-mapping-zebra-provided.xlsx using SheetJS.\n\n## Why\nNeed to import Zebra-provided HTB attribute mappings for semantic similarity matching with existing component types.\n\n## Scope\n- /scripts/htb-import/parse-htb-xlsx.ts - CREATE parser script\n- /scripts/htb-import/package.json - CREATE with xlsx dependency","design":"## Output Interface\ninterface ParsedHtbData {\n  metadata: { filename, parsedAt, sheetName }\n  columns: string[]\n  rows: Record\u003cstring, any\u003e[]\n  stats: { totalRows, uniqueAttributeNames }\n}\n\n## Key Column\nColumn A: Attribute Name for HTB - primary focus for embeddings","acceptance_criteria":"| Criterion | Proof | Expected |\n|-----------|-------|----------|\n| Script runs | bun run scripts/htb-import/parse-htb-xlsx.ts | No errors |\n| Extracts all columns | Check output | All XLSX columns present |\n| Column A values correct | Compare to XLSX | ~100 attribute names |\n| Stats reported | Check output | Row count, unique count |","status":"closed","priority":2,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-09T10:36:59.702238-06:00","updated_at":"2025-12-09T10:54:00.816049-06:00","closed_at":"2025-12-09T10:54:00.816049-06:00","labels":["parser","phase-2","xlsx"],"dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.2","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T10:36:59.702742-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr.3","title":"HTB Attribute Mapping Table Schema","description":"## What\nAdd Drizzle schema for htb_attribute_mapping_zebra_provided table to store XLSX data.\n\n## Why\nNeed persistent storage for HTB attribute mappings to enable semantic search and similarity matching.\n\n## Scope\n- /packages/db/src/schema/zebra.ts - MODIFY add new table schema","design":"## Table: htb_attribute_mapping_zebra_provided\n- id (serial, pk)\n- attribute_name_for_htb (text, unique index) - Column A\n- pim_attribute (text)\n- pim_data_type (text)\n- aem_fields (text)\n- notes (text)\n- created_at (timestamp)\n- updated_at (timestamp)","acceptance_criteria":"| Criterion | Proof | Expected |\n|-----------|-------|----------|\n| Schema defined | Check zebra.ts | Table with all columns |\n| Push succeeds | bun run db:push | No errors |\n| Table exists in Neon | Query database | Table accessible |\n| Unique index on Column A | Check schema | attribute_name_for_htb unique |","status":"closed","priority":2,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-09T10:36:59.895729-06:00","updated_at":"2025-12-09T11:05:07.164294-06:00","closed_at":"2025-12-09T11:05:07.164294-06:00","labels":["database","phase-2","schema"],"dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.3","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T10:36:59.896078-06:00","created_by":"daemon"},{"issue_id":"zebra-h2b-audit-v2-wxr.3","depends_on_id":"zebra-h2b-audit-v2-wxr.2","type":"blocks","created_at":"2025-12-09T10:37:21.727881-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr.4","title":"Import HTB Data to Database","description":"## What\nCreate import script to populate htb_attribute_mapping_zebra_provided table from parsed XLSX data.\n\n## Why\nNeed the data in database for embedding generation and similarity queries.\n\n## Scope\n- /scripts/htb-import/import-htb-data.ts - CREATE import script","design":"## Features\n- Deduplication via value hash\n- Idempotent (ON CONFLICT DO UPDATE)\n- Error handling per row\n- Progress logging\n- Statistics reporting\n\n## Flow\n1. Call parser to get data\n2. Transform to DB rows\n3. Batch insert with ON CONFLICT\n4. Report stats","acceptance_criteria":"| Criterion | Proof | Expected |\n|-----------|-------|----------|\n| Script runs | bun run scripts/htb-import/import-htb-data.ts | No errors |\n| All rows imported | Query table count | ~100 rows |\n| Idempotent | Re-run script | Same row count |\n| Stats reported | Check output | Inserted/updated counts |","status":"closed","priority":2,"issue_type":"task","estimated_minutes":45,"created_at":"2025-12-09T10:37:00.094641-06:00","updated_at":"2025-12-09T11:09:05.518248-06:00","closed_at":"2025-12-09T11:09:05.518248-06:00","labels":["database","import","phase-2"],"dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.4","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T10:37:00.094957-06:00","created_by":"daemon"},{"issue_id":"zebra-h2b-audit-v2-wxr.4","depends_on_id":"zebra-h2b-audit-v2-wxr.3","type":"blocks","created_at":"2025-12-09T10:37:21.752045-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr.5","title":"Config-Driven Embedding Sync Script","description":"## What\nCreate reusable embedding sync infrastructure:\n1. JSON config file defining table/column sources\n2. Incremental sync: NEW values only, delete STALE, skip unchanged\n3. Dual embeddings: BOTH embedding_large AND embedding_small\n\n## Why\nNeed robust, config-driven system to manage embeddings across multiple source tables with proper tracking.\n\n## Scope\n- /scripts/embeddings/package.json - CREATE\n- /scripts/embeddings/embedding-sources.json - CREATE config\n- /scripts/embeddings/config.ts - CREATE types\n- /scripts/embeddings/sync-embeddings.ts - CREATE main script","design":"## Config Format\n{ sources: [{ table, column, enabled }] }\n\n## Algorithm\n1. Load config\n2. For each source: find NEW (add), STALE (delete), UNCHANGED (skip)\n3. Batch generate BOTH embeddings via OpenAI\n4. Insert/delete with source tracking\n5. Report statistics","acceptance_criteria":"| Criterion | Proof | Expected |\n|-----------|-------|----------|\n| Config loads | bun run sync --dry-run | Shows sources |\n| NEW values detected | Run on fresh source | Reports X new |\n| STALE detected | Delete source row, re-run | Reports X stale |\n| Dual embeddings | Query embedding_large IS NOT NULL AND embedding_small IS NOT NULL | Both populated |\n| Source tracking | Query DISTINCT source_table, source_column | All sources listed |\n| Idempotent | Re-run immediately | 0 new, 0 stale |","status":"closed","priority":3,"issue_type":"task","estimated_minutes":180,"created_at":"2025-12-09T10:37:00.295097-06:00","updated_at":"2025-12-09T10:58:26.223274-06:00","closed_at":"2025-12-09T10:58:26.223274-06:00","labels":["embeddings","infrastructure","phase-3"],"dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.5","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T10:37:00.295439-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr.6","title":"Generate HTB Attribute Embeddings","description":"## What\nAdd HTB attribute source to embedding config and run sync to generate embeddings.\n\n## Why\nHTB attribute names need embeddings for semantic similarity matching with existing component types.\n\n## Scope\n- /scripts/embeddings/embedding-sources.json - MODIFY add HTB source\n- Run sync script to generate embeddings","design":"## New Config Entry\n{ name: HTB Attribute Names, table: htb_attribute_mapping_zebra_provided, column: attribute_name_for_htb, enabled: true }\n\n## Expected\n- ~100 new embeddings generated\n- Both embedding_large and embedding_small\n- source_table/source_column properly tracked","acceptance_criteria":"| Criterion | Proof | Expected |\n|-----------|-------|----------|\n| Config updated | Check JSON | HTB source present |\n| Embeddings generated | Query WHERE source_table=htb_attribute_mapping_zebra_provided | ~100 rows |\n| Dual embeddings | Check both columns | Non-null values |\n| Source tracked | Check source_column | attribute_name_for_htb |","status":"closed","priority":3,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-09T10:37:00.500043-06:00","updated_at":"2025-12-09T11:11:20.838558-06:00","closed_at":"2025-12-09T11:11:20.838558-06:00","labels":["embeddings","htb","phase-3"],"dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.6","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T10:37:00.500381-06:00","created_by":"daemon"},{"issue_id":"zebra-h2b-audit-v2-wxr.6","depends_on_id":"zebra-h2b-audit-v2-wxr.4","type":"blocks","created_at":"2025-12-09T10:37:21.775936-06:00","created_by":"daemon"},{"issue_id":"zebra-h2b-audit-v2-wxr.6","depends_on_id":"zebra-h2b-audit-v2-wxr.5","type":"blocks","created_at":"2025-12-09T10:37:21.800174-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr.7","title":"UMAP Coordinates and TSV Export","description":"## What\nCreate Python script (using uv) for:\n1. UMAP dimensionality reduction (2D and 3D)\n2. Update embedding_cache with UMAP coordinates\n3. Export TSV files for TensorFlow Projector\n\n## Why\nUMAP provides meaningful visualization of embedding relationships. TSV files enable TensorFlow Projector integration.\n\n## Scope\n- /scripts/embeddings/pyproject.toml - CREATE uv config\n- /scripts/embeddings/umap-reduce.py - CREATE UMAP script\n- /scripts/embeddings/tsv_export/ - CREATE output directory","design":"## UMAP Parameters\nn_neighbors=20, min_dist=0.1, metric=cosine\n\n## Outputs\n- embedding_cache.umap_x_2d, umap_y_2d (2D)\n- embedding_cache.umap_x_3d, umap_y_3d, umap_z_3d (3D)\n- tsv_export/embeddings.tsv (vectors)\n- tsv_export/metadata.tsv (labels)\n\n## Usage\nuv sync \u0026\u0026 uv run umap-reduce.py","acceptance_criteria":"| Criterion | Proof | Expected |\n|-----------|-------|----------|\n| uv project initializes | uv sync | Dependencies installed |\n| Script runs | uv run umap-reduce.py | Completes |\n| 2D coordinates | Query umap_x_2d, umap_y_2d | Non-null |\n| 3D coordinates | Query umap_x_3d, umap_y_3d, umap_z_3d | Non-null |\n| TSV files created | Check tsv_export/ | Files exist |\n| Projector compatible | Load in TensorFlow Projector | Renders |","status":"closed","priority":3,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-09T10:37:00.708647-06:00","updated_at":"2025-12-09T11:25:40.531716-06:00","closed_at":"2025-12-09T11:25:40.531716-06:00","labels":["phase-3","umap","visualization"],"dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.7","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T10:37:00.708979-06:00","created_by":"daemon"},{"issue_id":"zebra-h2b-audit-v2-wxr.7","depends_on_id":"zebra-h2b-audit-v2-wxr.6","type":"blocks","created_at":"2025-12-09T10:37:21.824635-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr.8","title":"Add OPENAI_API_KEY to environment configuration","description":"The embedding sync script requires OPENAI_API_KEY environment variable. Need to add this to .env.local or document where to obtain it.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-09T10:52:47.525232-06:00","updated_at":"2025-12-09T11:01:13.331262-06:00","closed_at":"2025-12-09T11:01:13.331262-06:00","dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.8","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T10:52:47.525617-06:00","created_by":"daemon"}]}
{"id":"zebra-h2b-audit-v2-wxr.9","title":"SQL error: correlated subquery in jsonb_agg for similar_matches","description":"## Bug\n/components page throws error due to correlated subquery inside jsonb_agg().\n\n## Root Cause\nPostgreSQL rejects correlated subqueries inside aggregate functions. The query tries to SELECT positions for each ec2.value inside the jsonb_agg.\n\n## Fix\nPre-compute positions in separate CTE (component_positions), then JOIN instead of subquery.\n\n## File\n/packages/api/src/routers/components.ts (lines 322-362)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-09T11:32:27.262857-06:00","updated_at":"2025-12-09T11:35:21.944454-06:00","closed_at":"2025-12-09T11:35:21.944454-06:00","dependencies":[{"issue_id":"zebra-h2b-audit-v2-wxr.9","depends_on_id":"zebra-h2b-audit-v2-wxr","type":"parent-child","created_at":"2025-12-09T11:32:27.263218-06:00","created_by":"daemon"}]}
